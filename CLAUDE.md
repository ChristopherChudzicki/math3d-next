# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Math3d-next is a 3D math visualization web app. Full-stack monorepo: React 19 + Redux Toolkit frontend, Django REST Framework + PostgreSQL backend.

## Common Commands

### Frontend (from repo root)

```bash
yarn install              # Install all dependencies
yarn start                # Dev server on port 3000 (proxies API to :8000)
yarn build                # Production build
yarn lint                 # Lint all packages (via Turbo)
yarn typecheck            # TypeScript checking (via Turbo)
yarn test                 # Run all Vitest tests (via Turbo)
yarn test-e2e             # Playwright E2E tests
yarn fmt-check            # Prettier format check
```

Run a single package's tasks:

```bash
yarn workspace app test
yarn workspace @math3d/parser test
```

### Task Runner (just)

```bash
just start                # Start frontend + backend dev servers
just be test              # Run backend tests (pytest)
just be typecheck         # MyPy
just fe test              # Run frontend tests (via yarn)
just fe lint              # Lint frontend (via yarn)
```

### Backend (Docker-based)

```bash
just be setup_python      # Initial setup
just be devserver         # Django dev server on :8000
just be test              # Run pytest
just be typecheck         # MyPy
```

### API Client Generation

The frontend API client (`packages/api/src/generated/`) is auto-generated from `webserver/openapi.yaml`. CI validates it matches. Regenerate with:

```bash
./scripts/generate_openapi.sh
```

## Architecture

### Deployment

This app is deployed as a true react SPA hosted on a CDN with APIs powered by DRF hosted elsewhere. There is no server-side rendering of React/HTML.

### Monorepo Layout (Yarn Workspaces + Turbo)

- **`packages/app`** — Main React app (Vite, port 3000). Entry: `src/main.tsx`
- **`packages/api`** — Auto-generated OpenAPI TypeScript/Axios client
- **`packages/mathscope`** — Math evaluation scope/variable management
- **`packages/parser`** — Expression parsing
- **`packages/custom-mathjs`** — Custom Math.js extensions
- **`packages/mathitem-configs`** — Configuration schemas for math objects
- **`packages/mock-api`** — MSW-based mock API for testing
- **`packages/app-tests-e2e`** — Playwright E2E tests
- **`packages/eslint-config`**, **`packages/tsconfig`**, **`packages/test-utils`** — Shared dev configs
- **`webserver/`** — Django REST API (runs in Docker)

### Frontend Stack

- **Rendering**: Vite dev/build, React 19, TypeScript (strict)
- **State**: Redux Toolkit. Main slice: `scene`. Store: `packages/app/src/store/store.ts`
- **UI**: MUI 7 + Emotion. Theme: `packages/app/src/mui.ts`
- **3D Visualization**: MathBox + Three.js
- **Math Input**: MathLive
- **Data Fetching**: TanStack React Query + Axios
- **Routing**: React Router v7. Routes: `packages/app/src/routes.tsx`
- **Styling**: CSS Modules (types auto-generated by `typed-css-modules`)
- **Path alias**: `@/*` maps to `src/*`

Feature-based organization in `packages/app/src/features/` (auth, sceneControls, notifications, scene, virtualKeyboard).

### Backend Stack

- **Framework**: Django 5 + DRF, Python 3.12
- **DB**: PostgreSQL 16 (Docker, port 5431 host / 5432 container)
- **Auth**: Djoser (JWT)
- **API Docs**: drf-spectacular → `webserver/openapi.yaml`
- **Deps**: Managed with `uv` (`webserver/pyproject.toml` + `webserver/uv.lock`)
- **Key apps**: `scenes/` (scene management), `scenes/math_items/` (math objects), `authentication/`

### Testing

- **Frontend unit tests**: Vitest + Testing Library + MSW mocks. Config in `packages/app/vite.config.ts`
- **Backend tests**: pytest + pytest-django + factory-boy. Config in `webserver/pyproject.toml`
- **E2E**: Playwright in `packages/app-tests-e2e/`

### Environment

- Node 20.20.0 (see `.nvmrc`), Yarn 4.8.1 (corepack)
- Dev env vars in `.env.development` (committed); local overrides in `.env` (gitignored)
- Pre-commit hooks: Prettier (JS/TS), Ruff (Python), trailing whitespace, secret detection

## Conventions

- Pull requests must follow the template in `.github/pull_request_template.md`
- Frontend tests: `*.test.tsx` / `*.spec.ts`
- Backend tests: `*_test.py`
- CSS Modules: `Component.module.css`
- Lint is strict: `max-warnings=0`
- ESLint extends Airbnb + Prettier
