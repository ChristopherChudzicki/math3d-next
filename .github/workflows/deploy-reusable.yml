name: ðŸ”’ _reusable deploy

on:
  workflow_call:
    inputs:
      environment:
        description: "Environment to deploy to (rc or production)"
        required: true
        type: string
      version:
        description: "Version number to deploy"
        required: true
        type: string
      dry_run:
        description: "If true, build artifacts but skip deployment"
        required: false
        type: boolean
        default: false
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      HEROKU_API_KEY:
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    env:
      SKIP_YARN_COREPACK_CHECK: true
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20.20.0"
          cache: "yarn"

      - name: Install dependencies
        run: |
          corepack enable
          yarn install --immutable

      - name: Build frontend
        run: yarn build
        env:
          VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL }}
          VITE_LEGACY_APP_BASE_URL: ${{ vars.VITE_LEGACY_APP_BASE_URL }}
          VITE_ISSUE_URL: ${{ vars.VITE_ISSUE_URL }}
          VITE_APP_VERSION: ${{ inputs.version }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.dry_run && format('frontend-build-{0}', inputs.version) || 'frontend-build' }}
          path: packages/app/dist/
          retention-days: ${{ inputs.dry_run && 30 || 1 }}

  deploy:
    needs: build
    if: ${{ !inputs.dry_run }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ vars.AWS_DEFAULT_REGION }}
      AWS_S3_BUCKET: ${{ vars.AWS_S3_BUCKET }}
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: packages/app/dist/

      - name: Deploy to AWS S3
        run: aws s3 cp --recursive packages/app/dist s3://${{ vars.AWS_S3_BUCKET }}/

      - name: Invalidate CloudFront cache
        run: aws cloudfront create-invalidation --distribution-id ${{ vars.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*"

      - name: Install Heroku CLI
        run: |
          curl https://cli-assets.heroku.com/install.sh | sh

      - name: Deploy to Heroku
        uses: akhileshns/heroku-deploy@v3.14.15
        with:
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          heroku_app_name: ${{ vars.HEROKU_APP_NAME }}
          heroku_email: ${{ vars.HEROKU_EMAIL }}
        env:
          HD_APP_VERSION: ${{ inputs.version }}
